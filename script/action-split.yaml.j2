# Code generated by gen. DO NOT EDIT.
name: build {{ name }} images

on:
  schedule:
    - cron: '0 0 * * 1'
  push:
    paths:
      - '{{ name }}/**'
      - '.github/workflows/build-{{ name }}.yaml'

jobs:
  reset-repo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Install dockerhub api
        run: pip3 install git+https://github.com/curoky/DockerHub-API typer

      - name: reset repo
        run: python3 ./script/reset-repo.py
        {%- raw %} ${{ secrets.DOCKER_USERNAME }} ${{ secrets.DOCKER_TOREN }} {%- endraw %} {{ name }}

  build:
    needs: [reset-repo]
    strategy:
      fail-fast: false
      matrix:
        os:
{%- for os in header.os %}
          - '{{ os }}'
{%- endfor %}
{%- if header.version %}
        version:
{%- for version in header.version %}
          - '{{ version }}'
{%- endfor %}
{%- endif%}

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: docker/setup-qemu-action@v1
      - uses: docker/setup-buildx-action@v1
      - uses: docker/login-action@v1
        with:
{%- raw %}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
{%- endraw %}

      - name: Build and push
        run: |
          ./{{ name }}/build.sh
          {%- raw %} ${{ matrix.os }} {% endraw -%}
{%- if header.version -%}
          {%- raw -%} ${{ matrix.version }} {% endraw -%}
{%- endif -%}
            --push
